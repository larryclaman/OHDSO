trigger: none

jobs:
  - job: detectionscan
    timeoutInMinutes: 5
    pool:
      vmImage: 'ubuntu-latest'

    variables:
      yelpimage: 'ghcr.io/larryclaman/dockerdetectsecrets:latest'
      pluginsdir: yelp-plugins

    steps:
      - bash: |
          docker pull $(yelpimage)
          docker run --rm --name detect-secrets --volume $(Build.Repository.LocalPath):/usr/src/app $(yelpimage) > $(Build.StagingDirectory)/creds.json
        displayName: Run detectsecrets container

      - bash: cat  $(Build.StagingDirectory)/creds.json
        displayName: Show detected creds
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.x'
          addToPath: true
          architecture: 'x64'

      - bash: |
          #pip install wheel
          pip install detect-secrets
        displayName: Install detect-secrets

      - bash: |
          # pipeline doesn't detect output, so have tool save output to file & cat it.
          touch $(Build.StagingDirectory)/creds.json
          echo "running scan"
          which detect-secrets
          python3 /opt/hostedtoolcache/Python/3.9.0/x64/bin/detect-secrets scan --custom-plugins $(Build.Repository.LocalPath)/$(pluginsdir)/azure_storage_key.py $(Build.Repository.LocalPath) > $(Build.StagingDirectory)/creds.json
          echo "ran scan"
          cat $(Build.StagingDirectory)/creds.json
        displayName: 'detect-secrets credentials scan'